# Blog System Setup Guide

Complete guide for the SoulPath blog system with external integration via Make.com.

## Project Structure

```
src/
├── services/
│   └── blogService.ts              # Firestore CRUD operations
├── pages/
│   ├── BlogsList.tsx               # Public blog list page
│   ├── BlogPage.tsx                # Individual blog post page
│   └── BlogAdmin.tsx               # Admin management panel
└── context/
    └── AuthContext.tsx             # (Already exists - handles authentication)

api/blogs/
└── createFromMake.ts               # Make.com webhook endpoint

firestore.rules                      # Firestore security rules
```

## 1. Database Structure (Firestore)

### Collection: `blogs`

Each document has the following structure:

```typescript
{
  id: string;                    // Auto-generated by Firestore
  title: string;                 // Blog post title
  slug: string;                  // URL-friendly identifier (unique)
  content: string;               // HTML or Markdown content
  coverImageUrl: string;         // Featured image URL
  createdAt: Timestamp;          // Creation timestamp
  updatedAt: Timestamp;          // Last update timestamp
  published: boolean;            // Publication status
  authorId: string;              // Firebase UID or "make-automation"
  source: "manual" | "make";     // Where the post came from
}
```

## 2. Frontend Components

### BlogsList.tsx
- **Route**: `/blogs`
- **Purpose**: Display all published blog posts in a grid
- **Features**:
  - Sorted by newest first
  - Shows cover image, title excerpt, date
  - Clicks navigate to individual post
  - Responsive design with hover effects

### BlogPage.tsx
- **Route**: `/blog/:slug`
- **Purpose**: Display individual blog post
- **Features**:
  - Dynamic routing by slug
  - Full HTML content rendering
  - Breadcrumb navigation
  - Shows publish date

### BlogAdmin.tsx
- **Route**: `/admin/blogs` (protected)
- **Purpose**: Management panel for blog posts
- **Features**:
  - Create new blog posts
  - Edit existing posts
  - Delete posts
  - Toggle publish status
  - Shows all posts (published + drafts)
  - **Requires authentication and admin role**

## 3. Firebase Setup

### 3.1 Enable Firestore Database

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select your `soulpath-795e4` project
3. Go to **Firestore Database**
4. Click **Create Database**
5. Choose **Production mode** (we'll set rules next)
6. Select region: `us-central1` (recommended)
7. Click **Create**

### 3.2 Deploy Security Rules

1. Install Firebase CLI (if not done):
   ```bash
   npm install -g firebase-tools
   ```

2. Login to Firebase:
   ```bash
   firebase login
   ```

3. Initialize Firebase in your project:
   ```bash
   firebase init
   ```
   - Select "Firestore" and "Functions"
   - Choose your project: `soulpath-795e4`

4. Replace `firestore.rules` content with the rules from this setup (already provided)

5. Deploy rules:
   ```bash
   firebase deploy --only firestore:rules
   ```

### 3.3 Set Custom Claims for Admin Users

**Note**: This must be done server-side. You have two options:

**Option A: Using Firebase Admin SDK (Recommended)**

Create a Cloud Function to set admin claims. For now, you can use the Firebase Console:

1. Go to **Authentication** > **Users**
2. Click the user you want to make admin
3. Click **Custom Claims** (in the right panel)
4. Add:
   ```json
   {
     "role": "admin"
   }
   ```
5. Click **Save**

**Option B: Programmatically (in a backend function)**

```typescript
import * as admin from 'firebase-admin';

const uid = 'user-id-here';
await admin.auth().setCustomUserClaims(uid, { role: 'admin' });
```

## 4. Environment Variables

Add to your `.env` file (already configured from Vercel):

```env
# Firebase Config (already present)
VITE_FIREBASE_API_KEY=AIzaSyAwT_7JXjtuFTeaAPn1wEPTRFPd7ryQCdo
VITE_FIREBASE_AUTH_DOMAIN=soulpath-795e4.firebaseapp.com
VITE_FIREBASE_PROJECT_ID=soulpath-795e4
VITE_FIREBASE_STORAGE_BUCKET=soulpath-795e4.firebasestorage.app
VITE_FIREBASE_MESSAGING_SENDER_ID=792662697137
VITE_FIREBASE_APP_ID=1:792662697137:web:484bae31332affeca6ee90

# Make.com API Key (add to Vercel)
MAKE_API_KEY=your-secret-make-api-key
```

**To add `MAKE_API_KEY` to Vercel**:

1. Go to your [Vercel Project Settings](https://vercel.com/dashboard)
2. Go to **Settings** > **Environment Variables**
3. Add:
   - **Name**: `MAKE_API_KEY`
   - **Value**: A secure random string (generate one: `openssl rand -hex 32`)
   - **Environments**: Select all (Production, Preview, Development)
4. Save and redeploy

## 5. Routing Setup

Add these routes to your `src/App.tsx`:

```typescript
import BlogsList from "./pages/BlogsList";
import BlogPage from "./pages/BlogPage";
import BlogAdmin from "./pages/BlogAdmin";
import ProtectedRoute from "./components/ProtectedRoute";

// In your router configuration:
<Route path="/blogs" element={<BlogsList />} />
<Route path="/blog/:slug" element={<BlogPage />} />
<Route
  path="/admin/blogs"
  element={
    <ProtectedRoute>
      <BlogAdmin />
    </ProtectedRoute>
  }
/>
```

## 6. Make.com Integration

### 6.1 Create API Key

1. Go to Vercel Project Settings
2. Generate a secure random string for `MAKE_API_KEY`
3. Set it as an environment variable

### 6.2 Make.com Automation Setup

1. Log in to [Make.com](https://www.make.com)
2. Create a new Scenario
3. Add a trigger (e.g., **Google Forms**, **Email**, **Webhook**, etc.)
4. Add action: **HTTP > Make a request**
5. Configure:

   ```
   URL: https://your-vercel-domain.vercel.app/api/blogs/createFromMake
   Method: POST
   Headers:
     - Key: x-api-key
       Value: [your MAKE_API_KEY]
     - Key: Content-Type
       Value: application/json
   
   Body (JSON):
   {
     "title": {{title}},
     "slug": {{slug}},
     "content": {{content}},
     "coverImageUrl": {{coverImageUrl}},
     "published": true,
     "source": "make"
   }
   ```

### 6.3 Expected Payload Format

**Request to `POST /api/blogs/createFromMake`:**

```json
{
  "title": "My Blog Post Title",
  "slug": "my-blog-post-title",
  "content": "<h1>Post Content</h1><p>Some text...</p>",
  "coverImageUrl": "https://example.com/image.jpg",
  "published": true,
  "source": "make"
}
```

**Successful Response (201):**

```json
{
  "success": true,
  "message": "Blog post created successfully",
  "id": "abc123xyz",
  "data": {
    "id": "abc123xyz",
    "title": "My Blog Post Title",
    "slug": "my-blog-post-title",
    "source": "make",
    "published": true
  }
}
```

**Error Response (400):**

```json
{
  "error": "Missing required fields: title, slug, and content are required"
}
```

## 7. Usage Guide

### For Admins (Manual Post Creation)

1. Navigate to `/admin/blogs`
2. Click **Create New Post**
3. Fill in form:
   - **Title**: Post title
   - **Slug**: URL-friendly identifier (e.g., `astrology-guide-2024`)
   - **Cover Image URL**: Link to featured image
   - **Content**: HTML or Markdown content
   - **Publish**: Toggle to publish/draft
   - **Source**: Select "Manual"
4. Click **Create Post**

### For Public Users

1. Navigate to `/blogs` to see all published posts
2. Click any post to read full content
3. Posts display in reverse chronological order

### For Make.com Automation

1. Set up scenario as described in section 6.2
2. Use API endpoint: `POST /api/blogs/createFromMake`
3. Posts created with `source: "make"` and `published: true`
4. They appear immediately in the blog list

## 8. Security Considerations

### Firestore Rules Summary

- ✅ **Anyone** can read published posts
- ✅ **Authors** can read their own draft posts
- ✅ **Admins only** can create new posts
- ✅ **Admins or authors** can update/delete their own posts
- ✅ **Make.com endpoint** requires valid API key in header

### Best Practices

1. **API Key Protection**:
   - Store `MAKE_API_KEY` in Vercel environment variables only
   - Never commit to GitHub
   - Rotate periodically

2. **Slug Uniqueness**:
   - Endpoint checks slug uniqueness before creating
   - Prevents duplicate entries

3. **Admin Access**:
   - Only users with custom claim `role: "admin"` can modify posts
   - Set via Firebase Console

## 9. Deployment

### Deploy to Vercel

```bash
git add .
git commit -m "Add blog system with Make.com integration"
git push origin main
```

Vercel auto-deploys on push. The `/api/blogs/createFromMake` endpoint is automatically available.

### Deploy Firestore Rules

```bash
firebase deploy --only firestore:rules
```

## 10. Testing

### Test Blog List

```bash
curl http://localhost:5174/blogs
```

### Test Blog Post (Slug)

```bash
curl http://localhost:5174/blog/my-blog-post-title
```

### Test Make.com Endpoint

```bash
curl -X POST http://localhost:3000/api/blogs/createFromMake \
  -H "x-api-key: your-make-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Post",
    "slug": "test-post",
    "content": "<p>Test content</p>",
    "coverImageUrl": "https://example.com/image.jpg",
    "published": true,
    "source": "make"
  }'
```

## 11. Troubleshooting

### "Missing OpenAI API key" on Blog Admin Page

- The blog admin doesn't require OpenAI
- This error comes from another component
- Ensure `.env` has `OPENAI_API_KEY` set

### Blog posts not appearing in list

- Check that `published: true` in Firestore
- Verify user has read permission (published posts are public)
- Check browser console for errors

### Make.com endpoint returns 401 Unauthorized

- Verify `x-api-key` header matches `MAKE_API_KEY` in Vercel
- Check environment variable spelling
- Redeploy after updating environment variables

### Firestore rules deployment fails

- Run `firebase login` to re-authenticate
- Ensure `firebase` CLI is up to date: `npm install -g firebase-tools@latest`
- Check for syntax errors in `firestore.rules`

## 12. API Reference

### `blogService.ts` Functions

```typescript
// Create a new blog post
createBlogPost(data: BlogPost): Promise<string>
// Returns: Document ID

// Update existing blog post
updateBlogPost(id: string, data: Partial<BlogPost>): Promise<void>

// Delete blog post
deleteBlogPost(id: string): Promise<void>

// Get all published blogs
fetchAllBlogs(): Promise<BlogPost[]>

// Get single blog by slug
fetchBlogBySlug(slug: string): Promise<BlogPost | null>

// Get all blogs (admin, includes drafts)
fetchAllBlogsAdmin(): Promise<BlogPost[]>

// Get blog by ID
getBlogPostById(id: string): Promise<BlogPost | null>
```

## 13. Next Steps

1. ✅ Files already created in your project
2. Add routes to `App.tsx`
3. Deploy Firestore rules: `firebase deploy --only firestore:rules`
4. Set admin user via Firebase Console
5. Test blog functionality
6. Configure Make.com automation
7. Create your first blog post!

## Support & Documentation

- [Firebase Docs](https://firebase.google.com/docs)
- [Make.com Docs](https://www.make.com/en/help)
- [Firestore Best Practices](https://firebase.google.com/docs/firestore/best-practices)
